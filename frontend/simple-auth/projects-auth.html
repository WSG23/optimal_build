<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - Authenticated</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; }
        .header { background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }

        button:hover { background: #2563eb; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .message {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üèóÔ∏è Optimal Build Projects</h1>
            <div class="user-info">
                <span>Welcome, <strong id="userName">User</strong></span>
                <button onclick="logout()" style="background: #ef4444;">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="message"></div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Projects</h3>
                <div style="font-size: 2rem; font-weight: bold;" id="totalProjects">0</div>
            </div>
            <div class="stat-card">
                <h3>My Projects</h3>
                <div style="font-size: 2rem; font-weight: bold;" id="myProjects">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Budget</h3>
                <div style="font-size: 2rem; font-weight: bold;" id="totalBudget">$0</div>
            </div>
            <div class="stat-card">
                <h3>Active Projects</h3>
                <div style="font-size: 2rem; font-weight: bold;" id="activeProjects">0</div>
            </div>
        </div>

        <!-- Controls -->
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
            <button onclick="showCreateModal()">‚ûï New Project</button>
            <button onclick="loadProjects()" style="background: #10b981;">üîÑ Refresh</button>
        </div>

        <!-- Projects Grid -->
        <h2 style="margin-bottom: 1rem;">All Projects</h2>
        <div id="projectsGrid" class="projects-grid">
            Loading projects...
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Project</h2>
            <div id="modalMessage"></div>

            <input type="text" id="projectName" placeholder="Project Name *" required>
            <textarea id="projectDescription" placeholder="Description" rows="3"></textarea>
            <input type="text" id="projectLocation" placeholder="Location">

            <select id="projectType">
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="industrial">Industrial</option>
                <option value="mixed">Mixed Use</option>
            </select>

            <select id="projectStatus">
                <option value="planning">Planning</option>
                <option value="approval">Approval</option>
                <option value="construction">Construction</option>
                <option value="completed">Completed</option>
            </select>

            <input type="number" id="projectBudget" placeholder="Budget (optional)" min="1">

            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button onclick="saveProject()">Save</button>
                <button onclick="hideModal()" style="background: #6b7280;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:9400/api/v1';
        let accessToken = null;
        let currentUser = null;
        let allProjects = [];
        let editingId = null;

        // Initialize
        window.onload = function() {
            checkAuth();
        };

        function checkAuth() {
            accessToken = localStorage.getItem('accessToken');
            const userStr = localStorage.getItem('currentUser');

            if (!accessToken || !userStr) {
                showMessage('Not authenticated. Redirecting to login...', 'warning');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            currentUser = JSON.parse(userStr);
            document.getElementById('userName').textContent = currentUser.full_name || currentUser.email;

            // Verify token is still valid
            validateToken();
            loadProjects();
        }

        async function validateToken() {
            try {
                const response = await fetch(`${API_URL}/users-db/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token invalid');
                }
            } catch (error) {
                showMessage('Session expired. Please login again.', 'error');
                setTimeout(() => logout(), 2000);
            }
        }

        async function loadProjects() {
            try {
                // Load all projects (no auth required for list)
                const response = await fetch(`${API_URL}/projects/list`);

                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }

                allProjects = await response.json();
                displayProjects();
                updateStats();

            } catch (error) {
                console.error('Error:', error);
                showMessage('Failed to load projects', 'error');
            }
        }

        function displayProjects() {
            const grid = document.getElementById('projectsGrid');

            if (allProjects.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #666;">No projects yet. Create your first project!</div>';
                return;
            }

            grid.innerHTML = allProjects.map(project => {
                const isOwner = project.owner_email === currentUser.email;

                return `
                    <div class="project-card">
                        <h3>${project.name}</h3>
                        <p><strong>Owner:</strong> ${project.owner_email}</p>
                        <p><strong>Type:</strong> ${project.project_type || 'Not specified'}</p>
                        <p><strong>Status:</strong> ${project.status}</p>
                        <p><strong>Location:</strong> ${project.location || 'Not specified'}</p>
                        <p><strong>Budget:</strong> ${project.budget ? '$' + project.budget.toLocaleString() : 'Not specified'}</p>
                        ${isOwner ? `
                            <div style="margin-top: 1rem;">
                                <button onclick="editProject('${project.id}')" style="background: #10b981;">Edit</button>
                                <button onclick="deleteProject('${project.id}')" style="background: #ef4444;">Delete</button>
                            </div>
                        ` : '<p style="color: #6b7280; font-style: italic;">View only</p>'}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const myProjects = allProjects.filter(p => p.owner_email === currentUser.email);
            const totalBudget = allProjects.reduce((sum, p) => sum + (p.budget || 0), 0);
            const activeCount = allProjects.filter(p => p.status !== 'completed').length;

            document.getElementById('totalProjects').textContent = allProjects.length;
            document.getElementById('myProjects').textContent = myProjects.length;
            document.getElementById('totalBudget').textContent = '$' + totalBudget.toLocaleString();
            document.getElementById('activeProjects').textContent = activeCount;
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Project';
            document.getElementById('modalMessage').innerHTML = '';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectType').value = 'residential';
            document.getElementById('projectStatus').value = 'planning';
            document.getElementById('projectBudget').value = '';
            editingId = null;
            document.getElementById('projectModal').classList.add('show');
        }

        function editProject(id) {
            const project = allProjects.find(p => p.id === id);
            if (!project) return;

            // Check ownership
            if (project.owner_email !== currentUser.email) {
                showMessage('You can only edit your own projects', 'error');
                return;
            }

            document.getElementById('modalTitle').textContent = 'Edit Project';
            document.getElementById('modalMessage').innerHTML = '';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectType').value = project.project_type || 'residential';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectBudget').value = project.budget || '';
            editingId = id;
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            if (!name) {
                showModalMessage('Project name is required', 'error');
                return;
            }

            const projectData = {
                name: name,
                description: document.getElementById('projectDescription').value.trim() || null,
                location: document.getElementById('projectLocation').value.trim() || null,
                project_type: document.getElementById('projectType').value,
                status: document.getElementById('projectStatus').value,
                budget: document.getElementById('projectBudget').value ?
                    parseFloat(document.getElementById('projectBudget').value) : null
            };

            try {
                const url = editingId ?
                    `${API_URL}/projects/${editingId}` :
                    `${API_URL}/projects/create`;
                const method = editingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(projectData)
                });

                if (response.status === 401) {
                    showModalMessage('Session expired. Please login again.', 'error');
                    setTimeout(() => logout(), 2000);
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save project');
                }

                hideModal();
                showMessage(editingId ? 'Project updated!' : 'Project created!', 'success');
                loadProjects();

            } catch (error) {
                showModalMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteProject(id) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const response = await fetch(`${API_URL}/projects/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 401) {
                    showMessage('Session expired. Please login again.', 'error');
                    setTimeout(() => logout(), 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to delete project');
                }

                showMessage('Project deleted!', 'success');
                loadProjects();

            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function hideModal() {
            document.getElementById('projectModal').classList.remove('show');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.className = 'message ' + type;
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function showModalMessage(text, type) {
            const msg = document.getElementById('modalMessage');
            msg.className = 'message ' + type;
            msg.textContent = text;
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>