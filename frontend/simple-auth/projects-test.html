<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Projects Dashboard (Test Mode)</h1>
        <p>This is a simplified test version that works without authentication</p>
        <button onclick="loadProjects()">Refresh Projects</button>
        <button onclick="showCreateModal()">+ New Project</button>
    </div>

    <div id="message"></div>

    <div id="projectsGrid" class="grid">
        <div style="grid-column: 1/-1; text-align: center; color: #999;">
            Loading projects...
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Project</h2>
            <div id="modalMessage" style="display: none;"></div>
            <input type="text" id="projectName" placeholder="Project Name" required>
            <input type="text" id="projectDescription" placeholder="Description">
            <input type="text" id="projectLocation" placeholder="Location">
            <select id="projectType">
                <option value="residential">Residential</option>
                <option value="commercial">Commercial</option>
                <option value="industrial">Industrial</option>
                <option value="mixed">Mixed Use</option>
            </select>
            <select id="projectStatus">
                <option value="planning">Planning</option>
                <option value="approval">Approval</option>
                <option value="construction">Construction</option>
                <option value="completed">Completed</option>
            </select>
            <input type="number" id="projectBudget" placeholder="Budget (optional)">
            <br><br>
            <button onclick="saveProject()">Save</button>
            <button onclick="hideModal()" style="background: #6b7280;">Cancel</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:9400/api/v1/projects';
        let projects = [];
        let editingId = null;

        // Load projects on page load
        window.onload = function() {
            loadProjects();
        };

        async function loadProjects() {
            try {
                const response = await fetch(`${API_URL}/list`);
                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }

                projects = await response.json();
                displayProjects();
                showMessage('Projects loaded successfully', 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage('Failed to load projects: ' + error.message, 'error');
                document.getElementById('projectsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #999;">
                        No projects found or unable to load
                    </div>
                `;
            }
        }

        function displayProjects() {
            const grid = document.getElementById('projectsGrid');

            if (projects.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #999;">
                        No projects yet. Click "+ New Project" to create one.
                    </div>
                `;
                return;
            }

            grid.innerHTML = projects.map(project => `
                <div class="card">
                    <h3>${project.name}</h3>
                    <p><strong>Type:</strong> ${project.project_type || 'N/A'}</p>
                    <p><strong>Status:</strong> ${project.status}</p>
                    <p><strong>Location:</strong> ${project.location || 'N/A'}</p>
                    <p><strong>Budget:</strong> $${(project.budget || 0).toLocaleString()}</p>
                    <button onclick="editProject('${project.id}')">Edit</button>
                    <button onclick="deleteProject('${project.id}')" style="background: #ef4444;">Delete</button>
                </div>
            `).join('');
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Project';
            document.getElementById('modalMessage').style.display = 'none';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectType').value = 'residential';
            document.getElementById('projectStatus').value = 'planning';
            document.getElementById('projectBudget').value = '';
            editingId = null;
            document.getElementById('projectModal').classList.add('show');
        }

        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            document.getElementById('modalTitle').textContent = 'Edit Project';
            document.getElementById('modalMessage').style.display = 'none';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectType').value = project.project_type || 'residential';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectBudget').value = project.budget || '';
            editingId = id;
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            // Get values from form
            const budgetValue = document.getElementById('projectBudget').value;
            const descValue = document.getElementById('projectDescription').value;
            const locValue = document.getElementById('projectLocation').value;

            // Build project data - use null for empty optional fields
            const projectData = {
                name: document.getElementById('projectName').value,
                description: descValue || null,
                location: locValue || null,
                project_type: document.getElementById('projectType').value,
                status: document.getElementById('projectStatus').value,
                budget: budgetValue ? parseFloat(budgetValue) : null
            };

            if (!projectData.name) {
                showModalMessage('Project name is required', 'error');
                return;
            }

            try {
                let response;
                if (editingId) {
                    response = await fetch(`${API_URL}/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });
                } else {
                    response = await fetch(`${API_URL}/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMsg = 'Failed to save project';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.detail || errorData.message || errorMsg;
                    } catch {
                        errorMsg = errorText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                hideModal();
                showMessage(editingId ? 'Project updated!' : 'Project created!', 'success');
                loadProjects();
            } catch (error) {
                console.error('Error saving:', error);
                showModalMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteProject(id) {
            if (!confirm('Delete this project?')) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete');
                }

                showMessage('Project deleted!', 'success');
                loadProjects();
            } catch (error) {
                console.error('Error:', error);
                showMessage('Failed to delete project', 'error');
            }
        }

        function hideModal() {
            document.getElementById('projectModal').classList.remove('show');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.className = type;
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }

        function showModalMessage(text, type) {
            const msg = document.getElementById('modalMessage');
            msg.className = type;
            msg.textContent = text;
            msg.style.display = 'block';
        }
    </script>
</body>
</html>