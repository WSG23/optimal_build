#!/bin/bash
# Pre-push hook to enforce code quality before pushing
# Install: ln -sf ../../.git-hooks/pre-push .git/hooks/pre-push

set -euo pipefail

if [ "${SKIP_PRE_PUSH_CHECKS:-0}" = "1" ]; then
    echo "⚠️  Skipping pre-push checks (SKIP_PRE_PUSH_CHECKS=1)"
    exit 0
fi

BASE_SHA=$(git merge-base HEAD origin/main 2>/dev/null || git rev-parse HEAD~1)
HEAD_SHA=$(git rev-parse HEAD)
CHANGED_FILES=$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" | tr '\n' ',' | sed 's/,$//')
DIFF_HASH=$(git diff "${BASE_SHA}" "${HEAD_SHA}" | shasum -a 256 | awk '{print $1}')

mkdir -p metrics
export AGENT_BASE_SHA="${BASE_SHA}"
export AGENT_HEAD_SHA="${HEAD_SHA}"
export AGENT_CHANGED_FILES="${CHANGED_FILES}"
export AGENT_DIFF_HASH="${DIFF_HASH}"
export AGENT_RUNS_FILE="metrics/agent_runs.jsonl"
export AGENT_MEMORY_FILE="metrics/agent_memory.jsonl"

if [ -x ".venv/bin/python" ]; then
    RUNNER_PY=".venv/bin/python"
else
    RUNNER_PY="python3"
fi

"${RUNNER_PY}" scripts/agents/runner.py verify --mode pre-pr --fail-fast
